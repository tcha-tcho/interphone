/**
 * Interphone.JS
 * @author  Tcha-Tcho <tchatcho66@hotmail.com>
 * @license  http://www.gnu.org/licenses/gpl.html
 */
 function interphone(a){this.o=window.extend({hosts:"*",serverUrl:"",lock_keys:[],closed:!1,target:"*",on_ready:function(){},on_data:function(){},on_msg:function(){}},a),this.init()}Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length>>>0,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1}),window.extend||(window.extend=function(){for(var a=arguments,b=1,c=a.length;c>b;b++)for(var d in a[b])a[b].hasOwnProperty(d)&&(a[0][d]=a[b][d]);return a[0]}),String.to_id||(String.prototype.to_id=function(){return this.replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})}),String.cypher||(String.prototype.cypher=function(a){for(var b="",c=0;c<this.length;c++){var d=a.charCodeAt(c%a.length);b+=String.fromCharCode(this.charCodeAt(c)^d)}return b}),interphone.prototype.locked=function(a){return-1!=this.o.lock_keys.indexOf(a)},interphone.prototype.send=function(a,b){var c=this,d={};d[a]=b;var e=JSON.stringify(d).cypher(c.pair+c.uuid);c.frame.postMessage(c.uuid+"--"+e,c.o.target)},interphone.prototype.send_msg=function(a){this.send("IPres_msg",a)},interphone.prototype.new_iframe=function(){var a=this,b=a.w.document;a.iframe=b.createElement("iframe"),a.iframe.name="xxxxxxx-xxxx-4xxx-yxxx".to_id()+"--"+a.uuid;var c=a.iframe.style;return c.position="absolute",c.left=c.top="-999px",b.getElementsByTagName("head")[0].appendChild(a.iframe),a.iframe.src=this.o.serverUrl,a.iframe},interphone.prototype.get_local=function(a,b){var c=new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),d=decodeURIComponent(document.cookie.replace(c,"$1"))||null,e=this.storage?this.storage.getItem(a):"!storage";return"storage"==b?e:"cookie"==b?d:"all"==b?e||d:void 0},interphone.prototype.set_local=function(a,b,c){return("cookie"==c||"all"==c)&&(document.cookie=encodeURIComponent(a)+"="+encodeURIComponent(b)),("storage"==c||"all"==c)&&this.storage&&this.storage.setItem(a,b),b},interphone.prototype.get=function(a,b){this.send("IPget_dt",[a,b||"storage"])},interphone.prototype.set=function(a,b,c){c=c||"storage",this.set_local(a,b,c),this.locked(a)||this.send("IPset_dt",[a,b,c])},interphone.prototype.onMessage=function(a,b){a||(a=window.event);var c=a.data||"",d=c.split("--")[0];if(d==b.pair){var e=c.split("--")[1].cypher(b.uuid+b.pair),f=JSON.parse(e),g="protected!";switch("*"!=b.o.hosts&&-1==b.o.hosts.indexOf(a.origin)&&(b.block="blocked"),!0){case!!f.IPok:b.ok=!0,"go"==f.IPok&&(f.IPok=b),b.o.on_ready(f.IPok);break;case!!f.IPtest_ok:b.send("IPok",b.block||"go");break;case!!b.block:return b.send("IPres",["key",g,"all"]),void 0}switch(!0){case!!f.IPget_dt:var h=f.IPget_dt,i=b.locked(h[0])||b.o.closed?g:b.get_local(h[0],h[1]);b.send("IPres",[h[0],i,h[1]]);break;case!!f.IPset_dt:var h=f.IPset_dt;b.locked(h[0])||b.o.closed?b.send("IPres",[h[0],g,h[2]]):(b.set_local(h[0],h[1],h[2]),b.o.on_data(h[0],h[1],h[2]));break;case!!f.IPres:var h=f.IPres;b.o.on_data(h[0],h[1],h[2]);break;case!!f.IPres_msg:b.o.on_msg(f.IPres_msg)}}},interphone.prototype.init=function(){var a=this;if(a.w=window,a.storage=a.w.localStorage,a.w.postMessage&&a.w.JSON){if(a.ifr=a.w.top!=a.w,a.ifr){var b=a.w.name.split("--");a.uuid=b[0],a.pair=b[1]}else a.uuid="xxxxxxx-xxxx-4xxx-yxxx".to_id();a.frame=a.ifr?a.w.top:a.new_iframe().contentWindow,a.ifr||(a.pair=a.iframe.name.split("--")[0]),a.w.addEventListener?a.w.addEventListener("message",function(b){a.onMessage(b,a)},!1):a.w.attachEvent&&a.w.attachEvent("onmessage",function(b){a.onMessage(b,a)});var c=a.w.setInterval(function(){a.ok?a.w.clearInterval(c):a.send("IPtest_ok",!0)},200)}};